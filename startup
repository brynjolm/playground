#!/bin/bash

# Function to post status
post_status() {
    if [ $1 -eq 0 ]; then
        echo "Success: $2"
    else
        echo "Failure: $2"
    fi
}

# Get DHCP hostname from DHCP lease file
dhcp_hostname=$(grep -oP '(?<=host-name ").*(?=";)' /var/lib/dhcp/dhclient.ens18.leases | tail -1)

# Set the DHCP hostname as the system hostname
if [ -n "$dhcp_hostname" ]; then
    hostnamectl set-hostname "$dhcp_hostname"
    post_status $? "Setting hostname to $dhcp_hostname"
    # Update /etc/hostname
    echo "$dhcp_hostname" > /etc/hostname
    post_status $? "Updating /etc/hostname"
    # Update /etc/hosts
    sed -i "s/127.0.1.1.*/127.0.1.1 $dhcp_hostname/g" /etc/hosts
    post_status $? "Updating /etc/hosts"
else
    echo "Could not determine DHCP-configured hostname."
fi

# Delete SSH host keys
rm -v /etc/ssh/ssh_host_*

# Reconfigure openssh-server
dpkg-reconfigure openssh-server
post_status $? "openssh-server configuration"

# Update package list
apt update
post_status $? "Package list update"

# Upgrade packages
apt upgrade -y
post_status $? "Package upgrade"

# Install required packages
apt install -y nano git qemu-guest-agent wget curl samba nfs-kernel-server cifs-utils ca-certificates gnupg
post_status $? "Package installation"

# Remove domain and search sections from /etc/resolv.conf
sed -i '/^domain/d' /etc/resolv.conf
sed -i '/^search/d' /etc/resolv.conf
post_status $? "Removing domain and search from /etc/resolv.conf"

# Set /etc/resolv.conf to have a nameserver of 192.168.200.1
echo "nameserver 192.168.200.1" > /etc/resolv.conf
post_status $? "Updating /etc/resolv.conf"

# Set timesyncd to use NTP server and Europe/Berlin timezone
echo "NTP=192.168.200.1" >> /etc/systemd/timesyncd.conf
timedatectl set-timezone Europe/Berlin
post_status $? "timesyncd configuration"

# Enable and start timesyncd service
systemctl enable systemd-timesyncd
systemctl start systemd-timesyncd

# Reboot the server
echo "Rebooting the system..."
reboot
