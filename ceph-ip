#!/bin/bash

# Function to check if an IP address is available
is_ip_available() {
    local ip="$1"
    if ! ping -c 1 -W 1 "$ip" > /dev/null 2>&1; then
        return 0  # IP is available
    else
        return 1  # IP is not available
    fi
}

# Function to post status
post_status() {
    if [ $1 -eq 0 ]; then
        echo "Success: $2"
    else
        echo "Failure: $2"
    fi
}

# Backup the original /etc/network/interfaces file
cp /etc/network/interfaces /etc/network/interfaces_backup

# Create /etc/network/interfaces_tmp with initial configuration
cat > /etc/network/interfaces_tmp << EOF
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
allow-hotplug ens18
iface ens18 inet dhcp
EOF

# Find an available IP address within the range for ens18
base_ip="192.200.0"
ip_range_start=100
ip_range_end=250
for ((i = ip_range_start; i <= ip_range_end; i++)); do
    ip="$base_ip.$i"
    if is_ip_available "$ip"; then
        break
    fi
done

if [ "$i" -le "$ip_range_end" ]; then
    # Append ens18 configuration to interfaces_tmp
    echo "
    # Configured by script
    auto ens18
    iface ens18 inet static
        address $ip
        netmask 255.255.0.0
        gateway 192.200.0.1
    " >> /etc/network/interfaces_tmp
    post_status $? "Configured ens18 with IP $ip"
else
    post_status 1 "No available IP found in range $base_ip.$ip_range_start - $base_ip.$ip_range_end"
fi

# Find an available IP address within the range
base_ip="172.200.0"
ip_range_start=10
ip_range_end=200
for ((i = ip_range_start; i <= ip_range_end; i++)); do
    ip="$base_ip.$i"
    if is_ip_available "$ip"; then
        break
    fi
done

if [ "$i" -le "$ip_range_end" ]; then
    # Modify /etc/network/interfaces for static IP on ens19
    echo "
    # Configured by script
    auto ens19
    iface ens19 inet static
        address $ip
        netmask 255.255.0.0
        gateway 172.200.0.1
    " >> /etc/network/interfaces
    post_status $? "Configured ens19 with IP $ip"
else
    post_status 1 "No available IP found in range $base_ip.$ip_range_start - $base_ip.$ip_range_end"
fi

# Overwrite /etc/network/interfaces with interfaces_tmp
cp /etc/network/interfaces_tmp /etc/network/interfaces

# Check the current default route
current_default_route=$(ip route show default | awk '/default/ {print $3}')

# If the current default route is not 192.200.0.1, update it
if [ "$current_default_route" != "192.200.0.1" ]; then
    # Delete the existing default route
    ip route del default
    
    # Set default route to 192.200.0.1
    ip route add default via 192.200.0.1
fi

